version: 2
jobs:
  one:
    docker:
      - image: circleci/ruby:2.4.1-jessie
    steps:
      - setup_remote_docker
      - run:
          name: Install node and npm
          command: |
            curl -sL https://deb.nodesource.com/setup_6.x | sudo -E bash -
            sudo apt-get install -y nodejs
            node --version && npm -v
      - run:
          name: Install Berlioz CLI
          command: |
            sudo npm i -g berlioz
      - checkout
      - run: 
          name: Project File Structure
          command: ls -la
      - run: 
          name: Service Definitions
          command: sudo berlioz output-definitions
      - run: 
          name: Service Definitions SUDO
          command: sudo -E bash -c 'berlioz output-definitions'
      # - run: 
      #     name: Berlioz Build Images
      #     command: sudo -E bash -c 'berlioz build'
      - run: 
          name: Berlioz Login
          command: sudo -E bash -c 'berlioz login --user $BERLIOZ_USER --pass $BERLIOZ_PASS'
      - run: 
          name: Berlioz Build and Push Images
          command: sudo -E bash -c 'berlioz push'
      - run: 
          name: Berlioz Trigger Run
          command: sudo -E bash -c 'berlioz run --deployment test --cluster hello --region us-east-1'
      - run: 
          name: Berlioz Check Status
          command: sudo -E bash -c 'berlioz status'
      # - run: 
      #     name: Manual Docker build
      #     command: |
      #       cd app
      #       docker build -t hello-app .
      - run: 
          name: List Docker Images
          command: docker images

workflows:
  version: 2
  one_and_two:
    jobs:
      - one